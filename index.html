<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>京阪神之旅 Family Trip</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        ice: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            500: '#0ea5e9', // Hokkaido Blue
                            600: '#0284c7',
                        }
                    },
                    fontFamily: {
                        sans: ['Noto Sans TC', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* 隱藏滾動條但保持功能 */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        body {
            background-color: #f0f9ff; /* 延伸底色 */
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body class="bg-ice-50 text-slate-700 h-screen overflow-hidden">

    <div id="app" class="h-full flex flex-col max-w-md mx-auto relative bg-ice-50 shadow-2xl overflow-hidden">
        
        <div class="relative w-full h-[250px] flex-shrink-0 z-0">
            <img src="Osaka.jpg" alt="Osaka Banner" class="w-full h-full object-cover">
            <div class="absolute inset-0 bg-gradient-to-b from-transparent to-black/30"></div>
            
            <div class="absolute bottom-10 right-4 flex space-x-3 z-20">
                <button @click="currentTab = 'itinerary'" :class="['w-10 h-10 rounded-full flex items-center justify-center shadow-lg transition-all', currentTab === 'itinerary' ? 'bg-ice-500 text-white scale-110' : 'bg-white/90 text-slate-500']">
                    <i class="fa-solid fa-map-location-dot"></i>
                </button>
                <button @click="currentTab = 'info'" :class="['w-10 h-10 rounded-full flex items-center justify-center shadow-lg transition-all', currentTab === 'info' ? 'bg-ice-500 text-white scale-110' : 'bg-white/90 text-slate-500']">
                    <i class="fa-solid fa-circle-info"></i>
                </button>
                <button @click="currentTab = 'shopping'" :class="['w-10 h-10 rounded-full flex items-center justify-center shadow-lg transition-all', currentTab === 'shopping' ? 'bg-ice-500 text-white scale-110' : 'bg-white/90 text-slate-500']">
                    <i class="fa-solid fa-basket-shopping"></i>
                </button>
                <button @click="currentTab = 'expenses'" :class="['w-10 h-10 rounded-full flex items-center justify-center shadow-lg transition-all', currentTab === 'expenses' ? 'bg-ice-500 text-white scale-110' : 'bg-white/90 text-slate-500']">
                    <i class="fa-solid fa-sack-dollar"></i>
                </button>
            </div>
        </div>

        <div class="flex-1 -mt-6 bg-ice-50 rounded-t-3xl z-10 relative overflow-hidden flex flex-col shadow-[0_-5px_15px_rgba(0,0,0,0.1)]">
            
            <div v-if="currentTab === 'itinerary'" class="h-full flex flex-col">
                <div class="px-6 pt-6 pb-2 flex items-center justify-between">
                    <div>
                        <h2 class="text-xl font-bold text-slate-800">大阪, 日本</h2>
                        <p class="text-xs text-slate-500">{{ formatDate(selectedDate) }}</p>
                    </div>
                    <div class="flex items-center space-x-3 bg-white px-3 py-1 rounded-full shadow-sm">
                        <i :class="weatherIcon" class="text-ice-500 text-xl"></i>
                        <div class="text-right">
                            <span class="block text-sm font-bold">5°C</span>
                            <span class="block text-[10px] text-slate-400">體感 2°C</span>
                        </div>
                    </div>
                </div>

                <div class="flex overflow-x-auto hide-scrollbar px-4 py-2 space-x-3 bg-ice-50 border-b border-ice-100 flex-shrink-0">
                    <div v-for="date in dates" :key="date.full" 
                         @click="selectedDate = date.full"
                         :class="['flex flex-col items-center justify-center min-w-[60px] h-16 rounded-xl transition-all cursor-pointer border', selectedDate === date.full ? 'bg-ice-500 text-white border-ice-500 shadow-md' : 'bg-white text-slate-400 border-transparent']">
                        <span class="text-sm font-bold">{{ date.day }}</span>
                        <span class="text-xs">{{ date.date }}</span>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto p-4 pb-20 space-y-0">
                    <div v-for="(item, index) in currentItinerary" :key="item.id" class="relative pl-4 pb-6 group"
                         draggable="true" 
                         @dragstart="dragStart(index)" 
                         @dragover.prevent 
                         @drop="drop(index)">
                        
                        <div v-if="index < currentItinerary.length" class="absolute left-0 top-8 bottom-0 w-0.5 bg-ice-200 ml-1.5"></div>
                        
                        <div v-if="index < currentItinerary.length - 1" class="absolute -left-2 top-[100%] z-10 bg-ice-100 px-2 py-0.5 rounded-md text-[10px] text-slate-500 border border-ice-200 flex items-center gap-1">
                             <i :class="getTransportIcon(item.transportMode)"></i> {{ item.transportTime || '15分' }}
                        </div>

                        <div class="relative flex items-start gap-3">
                            <div class="w-4 h-4 rounded-full bg-ice-500 border-4 border-ice-100 flex-shrink-0 mt-1.5 z-10"></div>
                            
                            <div @click="openMap(item.name)" class="flex-1 bg-white rounded-xl p-3 shadow-sm border border-slate-100 active:scale-95 transition-transform cursor-pointer">
                                <div v-if="index === 0 && selectedDate === '2026-02-20'" class="bg-ice-50 rounded-lg p-2 mb-2 border border-ice-200">
                                    <div class="flex justify-between items-center text-ice-600">
                                        <div class="text-center">
                                            <div class="text-lg font-bold">KHH</div>
                                            <div class="text-xs">06:55</div>
                                        </div>
                                        <div class="flex-1 flex flex-col items-center px-2">
                                            <i class="fa-solid fa-plane text-xs mb-1"></i>
                                            <div class="h-[1px] w-full bg-ice-300"></div>
                                            <div class="text-[10px] mt-1">IT284</div>
                                        </div>
                                        <div class="text-center">
                                            <div class="text-lg font-bold">KIX</div>
                                            <div class="text-xs">10:40</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-slate-800">{{ item.name }}</h3>
                                    <div class="flex gap-2">
                                        <button @click.stop="editItem(item)" class="text-slate-300 hover:text-ice-500"><i class="fa-solid fa-pen text-xs"></i></button>
                                    </div>
                                </div>
                                <div class="flex flex-wrap gap-2 mt-2 text-xs text-slate-500">
                                    <span v-if="item.time" class="bg-slate-100 px-1.5 py-0.5 rounded"><i class="fa-regular fa-clock mr-1"></i>{{ item.time }}</span>
                                    <span v-if="item.category" class="bg-ice-50 text-ice-600 px-1.5 py-0.5 rounded border border-ice-100">{{ item.category }}</span>
                                </div>
                                <p v-if="item.note" class="mt-2 text-xs text-slate-400 bg-slate-50 p-1.5 rounded">{{ item.note }}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div v-if="currentItinerary.length === 0" class="text-center py-10 text-slate-400">
                        <i class="fa-solid fa-calendar-plus text-4xl mb-2 text-ice-200"></i>
                        <p>點擊右下角新增行程</p>
                    </div>
                </div>

                <button @click="openAddModal" class="absolute bottom-6 right-6 w-14 h-14 bg-ice-500 text-white rounded-full shadow-xl flex items-center justify-center text-2xl hover:bg-ice-600 transition-colors z-30">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>

            <div v-if="currentTab === 'info'" class="h-full overflow-y-auto p-4 pb-20 space-y-4">
                <h2 class="text-2xl font-bold text-slate-800 mb-2">旅遊資訊</h2>
                
                <div class="bg-white p-4 rounded-xl shadow-sm border border-ice-100">
                    <h3 class="font-bold text-ice-600 mb-3"><i class="fa-solid fa-coins mr-2"></i>匯率換算</h3>
                    <div class="flex items-center gap-2">
                        <div class="flex-1">
                            <label class="text-xs text-slate-400">日幣 (JPY)</label>
                            <input type="number" v-model="calcJpy" class="w-full bg-slate-50 rounded p-2 text-lg font-bold border border-slate-200 focus:outline-none focus:border-ice-500">
                        </div>
                        <i class="fa-solid fa-arrow-right-arrow-left text-slate-300 mt-4"></i>
                        <div class="flex-1">
                            <label class="text-xs text-slate-400">台幣 (TWD)</label>
                            <div class="w-full bg-slate-50 rounded p-2 text-lg font-bold border border-slate-200 text-slate-600">
                                {{ (calcJpy * 0.215).toFixed(0) }}
                            </div>
                        </div>
                    </div>
                    <p class="text-[10px] text-right text-slate-400 mt-1">匯率約 0.215</p>
                </div>

                <div class="bg-white p-4 rounded-xl shadow-sm border border-ice-100">
                    <h3 class="font-bold text-ice-600 mb-3"><i class="fa-solid fa-plane-departure mr-2"></i>航班資訊</h3>
                    <div class="mb-4 border-b border-slate-100 pb-3">
                        <div class="flex justify-between items-center mb-1">
                            <span class="bg-ice-100 text-ice-600 text-xs px-2 py-0.5 rounded">去程 2/20</span>
                            <span class="text-xs text-slate-500">2h 45m</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-slate-800">KHH</div>
                                <div class="text-xs text-slate-500">06:55</div>
                            </div>
                            <div class="flex flex-col items-center px-4">
                                <i class="fa-solid fa-plane text-ice-400"></i>
                                <span class="text-[10px] text-slate-400">IT284</span>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-slate-800">KIX</div>
                                <div class="text-xs text-slate-500">10:40</div>
                                <div class="text-[10px] text-ice-500">T1</div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <span class="bg-ice-100 text-ice-600 text-xs px-2 py-0.5 rounded">回程 2/24</span>
                            <span class="text-xs text-slate-500">3h 30m</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-slate-800">KIX</div>
                                <div class="text-xs text-slate-500">11:30</div>
                                <div class="text-[10px] text-ice-500">T1</div>
                            </div>
                            <div class="flex flex-col items-center px-4">
                                <i class="fa-solid fa-plane text-ice-400 transform rotate-180"></i>
                                <span class="text-[10px] text-slate-400">IT285</span>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-slate-800">KHH</div>
                                <div class="text-xs text-slate-500">14:00</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-xl shadow-sm border border-ice-100">
                    <h3 class="font-bold text-ice-600 mb-3"><i class="fa-solid fa-bed mr-2"></i>住宿</h3>
                    <h4 class="font-bold text-lg">Eslead Hotel Namba South I</h4>
                    <p class="text-sm text-slate-500 mt-1"><i class="fa-solid fa-location-dot mr-1"></i> 大阪市浪速区日本橋...</p>
                    <div class="mt-3 flex gap-2">
                        <button @click="openMap('Eslead Hotel Namba South I')" class="flex-1 bg-ice-500 text-white py-2 rounded-lg text-sm shadow hover:bg-ice-600">導航</button>
                        <button class="w-10 bg-slate-100 text-slate-600 rounded-lg flex items-center justify-center"><i class="fa-solid fa-phone"></i></button>
                    </div>
                </div>

                 <div class="bg-red-50 p-4 rounded-xl shadow-sm border border-red-100">
                    <h3 class="font-bold text-red-500 mb-2"><i class="fa-solid fa-kit-medical mr-2"></i>緊急聯絡</h3>
                    <div class="flex justify-around mt-2">
                        <div class="text-center">
                            <div class="bg-white w-12 h-12 rounded-full flex items-center justify-center shadow text-red-500 text-xl mx-auto mb-1">110</div>
                            <span class="text-xs">警察</span>
                        </div>
                        <div class="text-center">
                            <div class="bg-white w-12 h-12 rounded-full flex items-center justify-center shadow text-red-500 text-xl mx-auto mb-1">119</div>
                            <span class="text-xs">救護車</span>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'shopping'" class="h-full overflow-y-auto p-4 pb-20">
                <h2 class="text-2xl font-bold text-slate-800 mb-4">購物清單</h2>
                <div class="grid grid-cols-2 gap-3">
                    <div v-for="(item, idx) in shoppingList" :key="idx" class="bg-white p-2 rounded-xl shadow-sm border border-slate-100 relative group">
                         <button @click="removeShoppingItem(idx)" class="absolute top-1 right-1 w-6 h-6 bg-red-100 text-red-500 rounded-full text-xs flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"><i class="fa-solid fa-times"></i></button>
                        <div class="h-32 bg-slate-100 rounded-lg mb-2 overflow-hidden flex items-center justify-center">
                            <img v-if="item.image" :src="item.image" class="w-full h-full object-cover">
                            <i v-else class="fa-solid fa-image text-slate-300 text-2xl"></i>
                        </div>
                        <h4 class="font-bold text-sm truncate">{{ item.name }}</h4>
                    </div>
                    <div @click="openShopModal" class="bg-ice-50 border-2 border-dashed border-ice-200 p-2 rounded-xl flex flex-col items-center justify-center h-44 cursor-pointer text-ice-400 hover:bg-ice-100 transition-colors">
                        <i class="fa-solid fa-camera mb-2 text-2xl"></i>
                        <span class="text-xs font-bold">新增物品</span>
                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'expenses'" class="h-full flex flex-col">
                <div class="bg-white p-6 pb-8 border-b border-slate-100 z-10">
                    <p class="text-slate-400 text-sm mb-1">總花費 (JPY)</p>
                    <h2 class="text-4xl font-bold text-slate-800">¥ {{ totalExpenses.toLocaleString() }}</h2>
                </div>
                <div class="flex-1 overflow-y-auto p-4 pb-20 space-y-3">
                    <div v-for="(exp, idx) in expenses" :key="idx" class="bg-white p-3 rounded-xl shadow-sm border border-slate-100 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-ice-50 text-ice-500 flex items-center justify-center text-lg">
                                <i :class="getCategoryIcon(exp.category)"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-sm text-slate-800">{{ exp.name }}</h4>
                                <p class="text-[10px] text-slate-400">{{ exp.date }} · {{ exp.payment }}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="block font-bold text-slate-700">¥{{ parseInt(exp.amount).toLocaleString() }}</span>
                        </div>
                    </div>
                </div>
                <button @click="openExpenseModal" class="absolute bottom-6 right-6 w-14 h-14 bg-ice-500 text-white rounded-full shadow-xl flex items-center justify-center text-2xl hover:bg-ice-600 transition-colors z-30">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>

        </div>

        <div v-if="showModal" class="absolute inset-0 z-50 bg-black/50 flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-sm rounded-2xl p-5 shadow-2xl animate-fade-in">
                <h3 class="font-bold text-lg mb-4">{{ isEditing ? '編輯行程' : '新增行程' }}</h3>
                <div class="space-y-3">
                    <input v-model="form.name" placeholder="名稱 (例: 清水寺)" class="w-full bg-slate-50 p-3 rounded-lg text-sm border focus:border-ice-500 outline-none">
                    <div class="flex gap-2">
                        <select v-model="form.category" class="flex-1 bg-slate-50 p-3 rounded-lg text-sm border outline-none">
                            <option value="景點">景點</option>
                            <option value="美食">美食</option>
                            <option value="購物">購物</option>
                            <option value="住宿">住宿</option>
                            <option value="其他">其他</option>
                        </select>
                         <input v-model="form.time" type="time" class="flex-1 bg-slate-50 p-3 rounded-lg text-sm border outline-none">
                    </div>
                     <div class="flex gap-2 bg-slate-50 p-2 rounded-lg">
                        <label class="text-xs text-slate-400 self-center mr-2">到此交通:</label>
                        <button @click="form.transportMode = 'walk'" :class="['flex-1 py-1 rounded text-xs', form.transportMode === 'walk' ? 'bg-white shadow text-ice-500' : 'text-slate-400']"><i class="fa-solid fa-person-walking"></i></button>
                        <button @click="form.transportMode = 'train'" :class="['flex-1 py-1 rounded text-xs', form.transportMode === 'train' ? 'bg-white shadow text-ice-500' : 'text-slate-400']"><i class="fa-solid fa-train-subway"></i></button>
                        <button @click="form.transportMode = 'car'" :class="['flex-1 py-1 rounded text-xs', form.transportMode === 'car' ? 'bg-white shadow text-ice-500' : 'text-slate-400']"><i class="fa-solid fa-car"></i></button>
                    </div>
                    <textarea v-model="form.note" placeholder="備註 / 門票資訊" class="w-full bg-slate-50 p-3 rounded-lg text-sm border focus:border-ice-500 outline-none h-20"></textarea>
                </div>
                <div class="flex gap-3 mt-6">
                    <button v-if="isEditing" @click="deleteItem" class="flex-1 bg-red-50 text-red-500 py-3 rounded-xl font-bold text-sm">刪除</button>
                    <button @click="closeModal" class="flex-1 bg-slate-100 text-slate-600 py-3 rounded-xl font-bold text-sm">取消</button>
                    <button @click="saveItem" class="flex-1 bg-ice-500 text-white py-3 rounded-xl font-bold text-sm">確認</button>
                </div>
            </div>
        </div>

        <div v-if="showShopModal" class="absolute inset-0 z-50 bg-black/50 flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-sm rounded-2xl p-5 shadow-2xl">
                <h3 class="font-bold text-lg mb-4">新增購物清單</h3>
                <input v-model="shopForm.name" placeholder="商品名稱" class="w-full bg-slate-50 p-3 rounded-lg text-sm border mb-3 outline-none">
                <label class="block w-full bg-slate-50 p-3 rounded-lg text-center text-slate-400 border border-dashed cursor-pointer hover:bg-slate-100">
                    <i class="fa-solid fa-camera mr-2"></i> 上傳圖片
                    <input type="file" @change="handleImageUpload" class="hidden" accept="image/*">
                </label>
                <div v-if="shopForm.image" class="mt-2 h-20 rounded overflow-hidden">
                    <img :src="shopForm.image" class="h-full w-full object-cover">
                </div>
                <div class="flex gap-3 mt-6">
                    <button @click="showShopModal = false" class="flex-1 bg-slate-100 text-slate-600 py-3 rounded-xl font-bold text-sm">取消</button>
                    <button @click="saveShopItem" class="flex-1 bg-ice-500 text-white py-3 rounded-xl font-bold text-sm">新增</button>
                </div>
            </div>
        </div>

        <div v-if="showExpenseModal" class="absolute inset-0 z-50 bg-black/50 flex items-center justify-center p-4">
             <div class="bg-white w-full max-w-sm rounded-2xl p-5 shadow-2xl">
                <h3 class="font-bold text-lg mb-4">記帳</h3>
                <div class="space-y-3">
                    <input type="date" v-model="expenseForm.date" class="w-full bg-slate-50 p-3 rounded-lg text-sm border outline-none">
                    <input v-model="expenseForm.name" placeholder="項目名稱" class="w-full bg-slate-50 p-3 rounded-lg text-sm border outline-none">
                    <input v-model="expenseForm.amount" type="number" placeholder="金額 (JPY)" class="w-full bg-slate-50 p-3 rounded-lg text-sm border outline-none">
                    <div class="flex gap-2">
                        <select v-model="expenseForm.category" class="flex-1 bg-slate-50 p-3 rounded-lg text-sm border outline-none">
                            <option value="飲食">飲食</option>
                            <option value="交通">交通</option>
                            <option value="購物">購物</option>
                            <option value="住宿">住宿</option>
                            <option value="其他">其他</option>
                        </select>
                        <select v-model="expenseForm.payment" class="flex-1 bg-slate-50 p-3 rounded-lg text-sm border outline-none">
                            <option value="現金">現金</option>
                            <option value="信用卡">信用卡</option>
                        </select>
                    </div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button @click="showExpenseModal = false" class="flex-1 bg-slate-100 text-slate-600 py-3 rounded-xl font-bold text-sm">取消</button>
                    <button @click="saveExpense" class="flex-1 bg-ice-500 text-white py-3 rounded-xl font-bold text-sm">儲存</button>
                </div>
             </div>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, reactive } = Vue;

        createApp({
            setup() {
                const currentTab = ref('itinerary');
                const selectedDate = ref('2026-02-20');
                const calcJpy = ref(1000);
                
                // 假資料: 天氣
                const weatherIcon = computed(() => {
                    const map = { 'Sun': 'fa-solid fa-sun', 'Cloud': 'fa-solid fa-cloud', 'Snow': 'fa-regular fa-snowflake' };
                    return map['Snow']; // 2月大阪設定為有雪/冷
                });

                const dates = [
                    { full: '2026-02-20', day: 'Fri', date: '2/20' },
                    { full: '2026-02-21', day: 'Sat', date: '2/21' },
                    { full: '2026-02-22', day: 'Sun', date: '2/22' },
                    { full: '2026-02-23', day: 'Mon', date: '2/23' },
                    { full: '2026-02-24', day: 'Tue', date: '2/24' }
                ];

                // 初始行程資料
                const itineraryData = reactive({
                    '2026-02-20': [
                        { id: 1, name: '抵達關西機場', time: '10:40', category: '航班', transportMode: 'train', transportTime: '45分' },
                        { id: 2, name: 'Check-in (Eslead Hotel)', time: '13:00', category: '住宿', transportMode: 'walk', transportTime: '10分' },
                        { id: 3, name: '新世界/通天閣', time: '14:00', category: '美食', transportMode: 'train', transportTime: '15分' },
                        { id: 4, name: '心齋橋/難波 購物', time: '16:00', category: '購物', transportMode: 'walk', transportTime: '10分' },
                        { id: 5, name: '燒肉力丸', time: '19:00', category: '美食', transportMode: 'walk', transportTime: '20分' },
                        { id: 6, name: '阿倍野 HARUKAS 300', time: '20:30', category: '景點', note: '看夜景' }
                    ],
                    '2026-02-21': [
                        { id: 1, name: '日本橋2號出口集合', time: '08:30', category: '其他', note: 'KKDay 一日團', transportMode: 'car', transportTime: '1小時' },
                        { id: 2, name: '勝尾寺', time: '10:00', category: '景點', transportMode: 'car', transportTime: '50分' },
                        { id: 3, name: '嵐山 (渡月橋/竹林)', time: '13:00', category: '景點', transportMode: 'car', transportTime: '40分' },
                        { id: 4, name: '伏見稻荷大社', time: '15:30', category: '景點', transportMode: 'car', transportTime: '1小時' },
                        { id: 5, name: '心齋橋覓食', time: '18:00', category: '美食' }
                    ],
                    '2026-02-22': [
                         { id: 1, name: '近鐵日本橋站集合', time: '08:00', category: '其他', note: 'KKDay 天橋立團', transportMode: 'car', transportTime: '2小時' },
                         { id: 2, name: '伊根灣遊船', time: '10:30', category: '景點', transportMode: 'car', transportTime: '30分' },
                         { id: 3, name: '天橋立 (傘松公園)', time: '13:00', category: '景點', transportMode: 'car', transportTime: '1小時' },
                         { id: 4, name: '美山茅屋之里', time: '15:30', category: '景點', transportMode: 'car', transportTime: '2小時' },
                         { id: 5, name: '蟹道樂東店/壽喜燒', time: '19:00', category: '美食', transportMode: 'walk', transportTime: '15分' },
                         { id: 6, name: '玉出超市 惠美須店', time: '21:00', category: '購物' }
                    ],
                    '2026-02-23': [
                        { id: 1, name: '環球影城 USJ', time: '08:00', category: '景點', note: '整天! 記得買快速通關', transportMode: 'train', transportTime: '30分' }
                    ],
                    '2026-02-24': [
                        { id: 1, name: 'Check-out', time: '08:00', category: '住宿', transportMode: 'train', transportTime: '50分' },
                        { id: 2, name: '關西機場 (KIX)', time: '09:30', category: '航班', note: 'IT285 11:30起飛' }
                    ]
                });

                const shoppingList = reactive([
                    { name: '合利他命 EX Plus', image: '' },
                    { name: 'Uniqlo 發熱衣', image: '' }
                ]);

                const expenses = reactive([
                    { name: 'KKDay 行程1', date: '2026-01-15', amount: 15000, category: '交通', payment: '信用卡' }
                ]);

                // Modal States
                const showModal = ref(false);
                const isEditing = ref(false);
                const form = reactive({ id: null, name: '', time: '', category: '景點', note: '', transportMode: 'walk' });
                
                const showShopModal = ref(false);
                const shopForm = reactive({ name: '', image: null });

                const showExpenseModal = ref(false);
                const expenseForm = reactive({ date: '2026-02-20', name: '', amount: '', category: '飲食', payment: '現金' });

                // Computed
                const currentItinerary = computed(() => {
                    return itineraryData[selectedDate.value] || [];
                });

                const totalExpenses = computed(() => {
                    return expenses.reduce((sum, item) => sum + parseInt(item.amount || 0), 0);
                });

                // Methods
                const formatDate = (dateStr) => {
                    const d = new Date(dateStr);
                    return `${d.getFullYear()}年${d.getMonth()+1}月${d.getDate()}日`;
                };

                const getCategoryIcon = (cat) => {
                    const map = { '景點': 'fa-camera', '住宿': 'fa-bed', '美食': 'fa-utensils', '購物': 'fa-bag-shopping', '交通': 'fa-train', '其他': 'fa-star', '航班': 'fa-plane' };
                    return `fa-solid ${map[cat] || 'fa-circle'}`;
                };

                const getTransportIcon = (mode) => {
                    const map = { 'walk': 'fa-person-walking', 'car': 'fa-car', 'train': 'fa-train-subway' };
                    return `fa-solid ${map[mode] || 'fa-person-walking'}`;
                };

                const openMap = (keyword) => {
                    if(!keyword) return;
                    window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(keyword)}`, '_blank');
                };

                // 行程 CRUD
                const openAddModal = () => {
                    isEditing.value = false;
                    Object.assign(form, { id: Date.now(), name: '', time: '', category: '景點', note: '', transportMode: 'walk' });
                    showModal.value = true;
                };

                const editItem = (item) => {
                    isEditing.value = true;
                    Object.assign(form, item);
                    showModal.value = true;
                };

                const saveItem = () => {
                    if (!itineraryData[selectedDate.value]) itineraryData[selectedDate.value] = [];
                    
                    if (isEditing.value) {
                        const idx = itineraryData[selectedDate.value].findIndex(i => i.id === form.id);
                        if (idx !== -1) itineraryData[selectedDate.value][idx] = { ...form };
                    } else {
                        itineraryData[selectedDate.value].push({ ...form });
                    }
                    closeModal();
                };

                const deleteItem = () => {
                    if(confirm('確定要刪除此行程嗎？')) {
                        const idx = itineraryData[selectedDate.value].findIndex(i => i.id === form.id);
                        if (idx !== -1) itineraryData[selectedDate.value].splice(idx, 1);
                        closeModal();
                    }
                };

                const closeModal = () => showModal.value = false;

                // Drag and Drop (Simple Sort)
                let dragStartIndex = null;
                const dragStart = (index) => dragStartIndex = index;
                const drop = (index) => {
                    const list = itineraryData[selectedDate.value];
                    const item = list.splice(dragStartIndex, 1)[0];
                    list.splice(index, 0, item);
                    dragStartIndex = null;
                };

                // 購物與圖片
                const openShopModal = () => {
                    shopForm.name = '';
                    shopForm.image = null;
                    showShopModal.value = true;
                };
                
                const handleImageUpload = (e) => {
                    const file = e.target.files[0];
                    if(file) {
                        shopForm.image = URL.createObjectURL(file);
                    }
                };

                const saveShopItem = () => {
                    if(shopForm.name) {
                        shoppingList.push({ ...shopForm });
                        showShopModal.value = false;
                    }
                };

                const removeShoppingItem = (idx) => {
                    if(confirm('刪除商品？')) shoppingList.splice(idx, 1);
                };

                // 花費
                const openExpenseModal = () => {
                    expenseForm.name = '';
                    expenseForm.amount = '';
                    showExpenseModal.value = true;
                };

                const saveExpense = () => {
                    if(expenseForm.amount) {
                        expenses.unshift({ ...expenseForm });
                        showExpenseModal.value = false;
                    }
                };

                return {
                    currentTab, dates, selectedDate, formatDate,
                    itineraryData, currentItinerary,
                    shoppingList, expenses, totalExpenses,
                    calcJpy,
                    weatherIcon,
                    getCategoryIcon, getTransportIcon,
                    openMap,
                    // Modal Actions
                    showModal, isEditing, form, openAddModal, editItem, saveItem, deleteItem, closeModal,
                    dragStart, drop,
                    // Shop
                    showShopModal, shopForm, openShopModal, handleImageUpload, saveShopItem, removeShoppingItem,
                    // Expense
                    showExpenseModal, expenseForm, openExpenseModal, saveExpense
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
